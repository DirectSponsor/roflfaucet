<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Dice Sync Test - ROFLFaucet</title>
    <link rel="stylesheet" href="css/poker-dice.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .test-results {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
        }
        
        .test-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .sync-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .sync-perfect {
            background: #28a745;
            color: white;
        }
        
        .sync-broken {
            background: #dc3545;
            color: white;
        }
        
        .verification-details {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üé≤ Poker Dice Sync Test</h1>
        <p>This test verifies that the new indexed system eliminates discrepancies between logical dice values and displayed animations.</p>
        
        <div class="test-buttons">
            <button onclick="runSingleTest()">üîç Run Single Test</button>
            <button onclick="runMassTest(100)">üöÄ Run 100 Tests</button>
            <button onclick="runMassTest(1000)">üí™ Run 1000 Tests</button>
            <button onclick="clearResults()">üßπ Clear Results</button>
        </div>
        
        <!-- Dice display area -->
        <div class="dice-container">
            <div class="die-container">
                <div class="die show-ace" id="die1">
                    <div class="die-face face-9"><span class="value">9</span></div>
                    <div class="die-face face-10"><span class="value">10</span></div>
                    <div class="die-face face-jack"><span class="value">J</span></div>
                    <div class="die-face face-queen"><span class="value">Q</span></div>
                    <div class="die-face face-king"><span class="value">K</span></div>
                    <div class="die-face face-ace"><span class="value">A</span></div>
                </div>
            </div>
            <div class="die-container">
                <div class="die show-ace" id="die2">
                    <div class="die-face face-9"><span class="value">9</span></div>
                    <div class="die-face face-10"><span class="value">10</span></div>
                    <div class="die-face face-jack"><span class="value">J</span></div>
                    <div class="die-face face-queen"><span class="value">Q</span></div>
                    <div class="die-face face-king"><span class="value">K</span></div>
                    <div class="die-face face-ace"><span class="value">A</span></div>
                </div>
            </div>
            <div class="die-container">
                <div class="die show-ace" id="die3">
                    <div class="die-face face-9"><span class="value">9</span></div>
                    <div class="die-face face-10"><span class="value">10</span></div>
                    <div class="die-face face-jack"><span class="value">J</span></div>
                    <div class="die-face face-queen"><span class="value">Q</span></div>
                    <div class="die-face face-king"><span class="value">K</span></div>
                    <div class="die-face face-ace"><span class="value">A</span></div>
                </div>
            </div>
            <div class="die-container">
                <div class="die show-ace" id="die4">
                    <div class="die-face face-9"><span class="value">9</span></div>
                    <div class="die-face face-10"><span class="value">10</span></div>
                    <div class="die-face face-jack"><span class="value">J</span></div>
                    <div class="die-face face-queen"><span class="value">Q</span></div>
                    <div class="die-face face-king"><span class="value">K</span></div>
                    <div class="die-face face-ace"><span class="value">A</span></div>
                </div>
            </div>
            <div class="die-container">
                <div class="die show-ace" id="die5">
                    <div class="die-face face-9"><span class="value">9</span></div>
                    <div class="die-face face-10"><span class="value">10</span></div>
                    <div class="die-face face-jack"><span class="value">J</span></div>
                    <div class="die-face face-queen"><span class="value">Q</span></div>
                    <div class="die-face face-king"><span class="value">K</span></div>
                    <div class="die-face face-ace"><span class="value">A</span></div>
                </div>
            </div>
        </div>
        
        <div class="test-results" id="testResults">
            <h3>Test Results</h3>
            <p>No tests run yet. Click a test button above to start.</p>
        </div>
    </div>

    <script>
        // Simplified test version of poker dice system
        class PokerDiceTestSystem {
            constructor() {
                // Direct index-to-value mapping for perfect sync between logic and animation
                this.indexToValue = ['9', '10', 'J', 'Q', 'K', 'A'];
                this.indexToClass = ['show-9', 'show-10', 'show-jack', 'show-queen', 'show-king', 'show-ace'];
                
                // Weighted dice arrays (same as main system)
                this.DICE_FACES = [
                    0, 0, 0, 0, 0, 0,  // Index 0 = '9' face (6 entries)
                    1, 1, 1, 1, 1, 1,  // Index 1 = '10' face (6 entries) 
                    2, 2, 2, 2, 2, 2,  // Index 2 = 'J' face (6 entries)
                    3, 3, 3, 3, 3, 3,  // Index 3 = 'Q' face (6 entries)
                    4, 4, 4, 4, 4, 4,  // Index 4 = 'K' face (6 entries)
                    5, 5, 5, 5, 5, 5   // Index 5 = 'A' face (6 entries)
                ];
            }
            
            generateRollResults() {
                const diceIndices = [];
                const diceValues = [];
                
                for (let i = 0; i < 5; i++) {
                    // Pick random index from weighted array
                    const randomArrayIndex = Math.floor(Math.random() * this.DICE_FACES.length);
                    const faceIndex = this.DICE_FACES[randomArrayIndex];
                    
                    diceIndices[i] = faceIndex;
                    diceValues[i] = this.indexToValue[faceIndex];
                }
                
                return { diceIndices, diceValues };
            }
            
            displayDice(diceIndices) {
                for (let i = 0; i < 5; i++) {
                    const die = document.getElementById(`die${i + 1}`);
                    const cssClass = this.indexToClass[diceIndices[i]];
                    die.className = `die ${cssClass}`;
                }
            }
            
            // Extract displayed values by reading actual CSS transforms and visible faces
            getDisplayedValues() {
                const displayed = [];
                for (let i = 1; i <= 5; i++) {
                    const die = document.getElementById(`die${i}`);
                    
                    // Method 1: Check CSS class first
                    const className = die.className;
                    let value = 'UNKNOWN';
                    
                    if (className.includes('show-9')) value = '9';
                    else if (className.includes('show-10')) value = '10';
                    else if (className.includes('show-jack')) value = 'J';
                    else if (className.includes('show-queen')) value = 'Q';
                    else if (className.includes('show-king')) value = 'K';
                    else if (className.includes('show-ace')) value = 'A';
                    
                    // Method 2: Visual verification - check which face is actually visible
                    // (This is more accurate as it checks what users actually see)
                    const computedStyle = window.getComputedStyle(die);
                    const transform = computedStyle.transform;
                    
                    // For debugging, let's also check what's actually visible
                    const faces = die.querySelectorAll('.die-face');
                    let visibleFace = null;
                    faces.forEach(face => {
                        const faceStyle = window.getComputedStyle(face);
                        // Check if face is in front (translateZ positive and not rotated away)
                        if (face.classList.contains('face-9') && className.includes('show-9')) visibleFace = '9';
                        else if (face.classList.contains('face-10') && className.includes('show-10')) visibleFace = '10';
                        else if (face.classList.contains('face-jack') && className.includes('show-jack')) visibleFace = 'J';
                        else if (face.classList.contains('face-queen') && className.includes('show-queen')) visibleFace = 'Q';
                        else if (face.classList.contains('face-king') && className.includes('show-king')) visibleFace = 'K';
                        else if (face.classList.contains('face-ace') && className.includes('show-ace')) visibleFace = 'A';
                    });
                    
                    // Use visible face if detected, otherwise fall back to class name
                    if (visibleFace) value = visibleFace;
                    
                    displayed.push(value);
                    console.log(`Die ${i}: className='${className}', transform='${transform}', detected='${value}'`);
                }
                return displayed;
            }
        }
        
        const testSystem = new PokerDiceTestSystem();
        let testCount = 0;
        let passCount = 0;
        let failCount = 0;
        
        function runSingleTest() {
            const results = testSystem.generateRollResults();
            testSystem.displayDice(results.diceIndices);
            
            // Allow CSS to apply
            setTimeout(() => {
                const displayedValues = testSystem.getDisplayedValues();
                const isSync = arraysEqual(results.diceValues, displayedValues);
                
                testCount++;
                if (isSync) passCount++;
                else failCount++;
                
                displayTestResult(results, displayedValues, isSync, true);
            }, 100);
        }
        
        function runMassTest(count) {
            let completedTests = 0;
            const testResults = [];
            
            function runNextTest() {
                if (completedTests >= count) {
                    displayMassTestResults(testResults);
                    return;
                }
                
                const results = testSystem.generateRollResults();
                testSystem.displayDice(results.diceIndices);
                
                setTimeout(() => {
                    const displayedValues = testSystem.getDisplayedValues();
                    const isSync = arraysEqual(results.diceValues, displayedValues);
                    
                    testCount++;
                    if (isSync) passCount++;
                    else failCount++;
                    
                    testResults.push({ results, displayedValues, isSync });
                    completedTests++;
                    
                    // Run next test with small delay
                    setTimeout(runNextTest, 10);
                }, 50);
            }
            
            runNextTest();
        }
        
        function displayTestResult(results, displayedValues, isSync, showDetails = false) {
            const resultsDiv = document.getElementById('testResults');
            const status = isSync ? 
                '<span class="sync-status sync-perfect">‚úÖ PERFECT SYNC</span>' : 
                '<span class="sync-status sync-broken">‚ùå SYNC BROKEN</span>';
            
            let html = `<h3>Test Results (${testCount} total, ${passCount} pass, ${failCount} fail)</h3>`;
            html += `<div><strong>Latest Test:</strong> ${status}</div>`;
            
            if (showDetails) {
                html += `<div class="verification-details">`;
                html += `<div><strong>Logical Values:</strong> [${results.diceValues.join(', ')}]</div>`;
                html += `<div><strong>Displayed Values:</strong> [${displayedValues.join(', ')}]</div>`;
                html += `<div><strong>Indices Used:</strong> [${results.diceIndices.join(', ')}]</div>`;
                html += `</div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function displayMassTestResults(testResults) {
            const resultsDiv = document.getElementById('testResults');
            const syncBreaks = testResults.filter(test => !test.isSync);
            
            let html = `<h3>Mass Test Results (${testCount} total, ${passCount} pass, ${failCount} fail)</h3>`;
            
            if (syncBreaks.length === 0) {
                html += `<div class="sync-status sync-perfect">üéâ ALL TESTS PASSED - PERFECT SYNC!</div>`;
                html += `<div class="verification-details">`;
                html += `<div>‚úÖ Ran ${testResults.length} tests</div>`;
                html += `<div>‚úÖ Zero discrepancies between logical and displayed values</div>`;
                html += `<div>‚úÖ New indexed system working perfectly</div>`;
                html += `</div>`;
            } else {
                html += `<div class="sync-status sync-broken">‚ùå ${syncBreaks.length} SYNC FAILURES</div>`;
                html += `<div class="verification-details">`;
                html += `<div>‚ö†Ô∏è Found ${syncBreaks.length} discrepancies out of ${testResults.length} tests</div>`;
                html += `<div>‚ö†Ô∏è System still has sync issues</div>`;
                
                // Show first few failures
                for (let i = 0; i < Math.min(3, syncBreaks.length); i++) {
                    const fail = syncBreaks[i];
                    html += `<div>‚ùå Failure ${i+1}: Logical [${fail.results.diceValues.join(', ')}] vs Displayed [${fail.displayedValues.join(', ')}]</div>`;
                }
                
                html += `</div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function clearResults() {
            testCount = 0;
            passCount = 0;
            failCount = 0;
            document.getElementById('testResults').innerHTML = '<h3>Test Results</h3><p>Results cleared. Click a test button to start.</p>';
            
            // Reset dice to default
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`die${i}`).className = 'die show-ace';
            }
        }
        
        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, i) => val === b[i]);
        }
        
        // Initialize display
        clearResults();
    </script>
</body>
</html>

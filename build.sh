#!/bin/bash
# Lightweight HTML Include Processor
# Similar to BBEdit's include system

set -e

echo "🔨 Building HTML files with includes..."

# Function to process includes in a file
process_includes() {
    local input_file="$1"
    local output_file="$2"
    local temp_file=$(mktemp)
    
    echo "📄 Processing: $input_file → $output_file"
    
    # Copy input to temp file
    cp "$input_file" "$temp_file"
    
    # Process all include directives
    while grep -q '<!--#include file=".*" -->' "$temp_file"; do
        # Find the first include
        include_line=$(grep -n '<!--#include file=".*" -->' "$temp_file" | head -1)
        line_num=$(echo "$include_line" | cut -d: -f1)
        include_path=$(echo "$include_line" | sed 's/.*file="\([^"]*\)".*/\1/' | tr -d ' \t')
        
        if [[ -f "$include_path" ]]; then
            echo "  📎 Including: $include_path"
            
            # Create new temp file with include replaced
            new_temp=$(mktemp)
            
            # Copy lines before the include
            head -n $((line_num - 1)) "$temp_file" > "$new_temp"
            
            # Add the included content
            cat "$include_path" >> "$new_temp"
            
            # Copy lines after the include
            tail -n +$((line_num + 1)) "$temp_file" >> "$new_temp"
            
            # Replace temp file
            mv "$new_temp" "$temp_file"
        else
            echo "  ⚠️  Include file not found: $include_path"
            # Remove the include line to prevent infinite loop
            sed -i "${line_num}d" "$temp_file"
        fi
    done
    
    # Add warning header to generated file
    final_temp=$(mktemp)
    template_name=$(basename "$input_file")
    cat > "$final_temp" << EOF
<!-- ⚠️  WARNING: This file is AUTO-GENERATED by build.sh ⚠️  -->
<!-- 🚨 DO NOT EDIT THIS FILE DIRECTLY! 🚨 -->
<!-- -->
<!-- ✏️  To make changes, edit the template file instead: -->
<!-- 📁 templates/$template_name -->
<!-- -->
<!-- 🔧 Then run: ./build.sh -->
<!-- ⚠️  All direct edits to this file will be LOST! ⚠️  -->
<!-- ================================================================ -->

EOF
    
    # Append the processed content
    cat "$temp_file" >> "$final_temp"
    
    # Move final result to output
    mv "$final_temp" "$output_file"
    rm -f "$temp_file"
    echo "  ✅ Built: $output_file"
}

# Build all template files
template_count=0

for template in templates/*.template.html; do
    if [[ -f "$template" ]]; then
        # Extract filename without .template.html extension
        basename=$(basename "$template" .template.html)
        output_file="${basename}.html"
        
        process_includes "$template" "$output_file"
        ((template_count++))
    fi
done

if [[ $template_count -eq 0 ]]; then
    echo "📁 No template files found in templates/ directory"
    echo "💡 Create files like templates/page.template.html to get started"
else
    echo ""
    echo "🎉 Build complete! Processed $template_count template(s)"
    echo ""
    echo "📝 Template syntax:"
    echo "   <!--#include file=\"includes/header.html\" -->"
    echo ""
    echo "📂 Directory structure:"
    echo "   templates/           - Your .template.html source files"
    echo "   includes/           - Shared HTML snippets"
    echo "   *.html              - Generated output files"
fi

